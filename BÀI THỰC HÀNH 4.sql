USE KTT
CREATE DATABASE QLBH9
ON PRIMARY
( NAME = 'QuanlyBH', FILENAME = 'D:\CSDL\QLBH2.mdf' , 
SIZE = 4048KB , MAXSIZE = 10240KB , FILEGROWTH = 20%)
LOG ON
( NAME = 'QLBH2_log', FILENAME = 'D:\CSDL\QLBH2_log1.ldf' , 
SIZE = 1024KB , MAXSIZE = 10240KB , FILEGROWTH = 10%)
USE KTT
CREATE TABLE NhomSanPham
(	MaNhom INT PRIMARY KEY NOT NULL, 
	TenNhom NVARCHAR(15) NULL)
CREATE TABLE SanPham
(	MaSp INT PRIMARY KEY NOT NULL, 
	TenSp NVARCHAR(40) NOT NULL,
	Donvitinh NVARCHAR(20) NULL, 
	GiaGoc MONEY NULL, 
	SLTON INT NULL,
	MaNhom INT NULL, 
	MaNCC INT NULL, 
	MoTa NVARCHAR(50) NULL)
CREATE TABLE HoaDon
(	MaHD INT PRIMARY KEY NOT NULL,
	NgayLapHD DATETIME NULL,
	MaKh NCHAR(5) NULL,
	NgayGiao DATETIME NULL,
	Noichuyen NVARCHAR(60) NOT NULL,
	MaNV INT NULL)
CREATE TABLE CT_HoaDon
(	MaHD INT NOT NULL,
	MaSp INT NOT NULL,
	Dongia MONEY NULL,
	Soluong SMALLINT NULL,
	ChietKhau MONEY NULL,
PRIMARY KEY CLUSTERED
([MaHD] ASC,
 [MaSp] ASC)
WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, 
ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]) 
ON [PRIMARY]
CREATE TABLE NhaCungCap
(	MaNCC INT PRIMARY KEY NOT NULL, 
	TenNcc NVARCHAR(40) NOT NULL, 
	Diachi NVARCHAR(60) NULL, 
	Phone NVARCHAR(24) NULL, 
	SoFax NVARCHAR(24) NULL, 
	DCMail NVARCHAR(50)NULL)
CREATE TABLE KhachHang
(	MaKH NCHAR(5) PRIMARY KEY NOT NULL, 
	TenKh NVARCHAR(40) NOT NULL,
	Diachi NVARCHAR(60) NULL, 
	Phone NVARCHAR(24) NULL,
	LoaiKh NVARCHAR(3) NULL,  
	SoFax NVARCHAR(24) NULL, 
	DCMail NVARCHAR(50) NULL, 
	DiemTL INT NULL)
CREATE TABLE NhanVien
(	MaNV INT PRIMARY KEY NOT NULL,
	TenNV NVARCHAR(40) NOT NULL, 
	Diachi NVARCHAR(60) NULL, 
	Phone NVARCHAR(60) NULL)

ALTER TABLE HoaDon WITH CHECK ADD FOREIGN KEY (MaKH) REFERENCES KhachHang (MaKh)
ALTER TABLE HoaDon WITH CHECK ADD FOREIGN KEY (MaNV) REFERENCES NhanVien (MaNV)
ALTER TABLE CT_HoaDon WITH CHECK ADD FOREIGN KEY (MaHD) REFERENCES HoaDon (MaHD)
ALTER TABLE CT_HoaDon WITH CHECK ADD FOREIGN KEY (MaSp) REFERENCES SanPham (MaSp)
ALTER TABLE SanPham WITH CHECK ADD FOREIGN KEY (MaNhom) REFERENCES NhomSanPham (MaNhom)
ALTER TABLE SanPham WITH CHECK ADD FOREIGN KEY (MaNCC) REFERENCES NhaCungCap (MaNCC)
ALTER TABLE SanPham WITH CHECK ADD CONSTRAINT [SP_CK_1] CHECK (([Giagoc]>(0)))
ALTER TABLE SanPham CHECK CONSTRAINT [SP_CK_1]
ALTER TABLE SanPham WITH CHECK ADD CONSTRAINT [SP_CK_2] CHECK (([SLTON]>(0)))
ALTER TABLE SanPham CHECK CONSTRAINT [SP_CK_2]
ALTER TABLE HoaDon WITH CHECK ADD CONSTRAINT [HD_CK] CHECK (([NgayLapHD]>= GETDATE()))
ALTER TABLE HoaDon CHECK CONSTRAINT [HD_CK]
ALTER TABLE CT_HoaDon WITH CHECK ADD CONSTRAINT [CTHD_CK_1] CHECK (([Soluong]>(0)))
ALTER TABLE CT_HoaDon CHECK CONSTRAINT [CTHD_CK_1]
ALTER TABLE CT_HoaDon WITH CHECK ADD CONSTRAINT [CTHD_CK_2] CHECK (([ChietKhau]>(0)))
ALTER TABLE CT_HoaDon CHECK CONSTRAINT [CTHD_CK_2]
ALTER TABLE KhachHang WITH CHECK ADD CONSTRAINT [KH_CK_1] CHECK (([LoaiKh]='VIP' OR [LoaiKh]='TV' OR [LoaiKh]='VL'))
ALTER TABLE KhachHang CHECK CONSTRAINT [KH_CK_1]  
ALTER TABLE KhachHang WITH CHECK ADD CONSTRAINT [KH_CK_2] CHECK (([DiemTL]>=(0)))
ALTER TABLE HoaDon ADD LoaiHD CHAR(1)
ALTER TABLE HoaDon WITH CHECK ADD CONSTRAINT [CT_HoaDon_CK_3] CHECK (([LoaiHD]='N' OR [LoaiHD]='X' OR [LoaiHD]='C'))
ALTER TABLE HoaDon WITH CHECK ADD CONSTRAINT [DF_HoaDon_LoaiHD] DEFAULT 'N' FOR LoaiHD
ALTER TABLE HoaDon ADD CONSTRAINT [HD_CK_3] CHECK (([NgayGiao]>=[NgayLapHD]))

USE KTT
DELETE FROM NhomSanPham
DELETE FROM NhaCungCap
DELETE FROM SanPham
DELETE FROM KhachHang
DELETE FROM HoaDon
DELETE FROM CT_HoaDon
ALTER TABLE NhomSanPham 
ALTER COLUMN TenNhom NVARCHAR(50);
EXEC sp_help 'NhomSanPham';

INSERT INTO NhomSanPham 
VALUES 
	(1,N'Điện Tử'),
	(2,N'Gia Dụng'), 
	(3,N'Dụng Cụ Gia Đình'), 
	(4,N'Các Mặt Hàng Khác')
SELECT * FROM NhomSanPham
INSERT INTO NhaCungCap 
VALUES 
	(1,N'Công Ty TNHH Nam Phương',N'1 Lê Lợi Phường 4 Quận Gò Vấp', '083843456', '32343434', 'NamPhuong@yahoo.com'),
	(2,N'Công Ty Lan Ngọc', N'12 Cao Bá Quát Quận 1 Tp. Hồ Chí Minh', '086234567','83434355','LanNgoc@gmail.com')
SELECT * FROM NhaCungCap
INSERT INTO SanPham 
VALUES 
	(1,N'Máy Tính',N'Cái','7000.0000',100, 1,1,N'Máy Sony Ram 2GB'),
	(2,N'Bàn Phím',N'Cái','10000.0000',50,1,1,N'Bàn Phím 101 phím'),
	(3,N'Chuột',N'Cái','800.0000',150,1,1,N'Chuột Không Dây'),
	(4,N'CPU',N'Cái','3000.0000',200,1,1,N'CPU'),
	(5,N'USP',N'Cái','500.0000',100,1,1,'8GB'),
	(6,N'Lò Vi Sóng', N'Cái','1000000.0000',20,3,2,NULL)
SELECT * FROM SanPham
INSERT INTO KhachHang 
VALUES 
	('KH01',N'Nguyễn Thu Hằng',N'12 Nguyễn Du','','VL',NULL,NULL,NULL),
	('KH02 ',N'Lê Minh',N'34 Điện Biên Phủ', '0123943455','TV',NULL,'LeMinh@yahoo.com','100'),
	('KH03',N'Nguyễn Minh Trung',N'3 Lê Lợi Quận Gò Vấp','098343434','VIP', NULL,'Trung@gmail.com','800')
SELECT * FROM KhachHang
INSERT INTO HoaDon 
VALUES 
	(1,'2025-03-08 00:00:00','KH01', '2025-03-10 00:00:00', N'Cửa Hàng ABC Lý Chính Thắng Quận 3',NULL, NULL),
	(2,'2025-07-29 00:00:00','KH02','2025-08-10 00:00:00',N'23 Lê Lợi Quận Gò Vấp',NULL, NULL),
	(3,'2025-10-01 00:00:00','KH03','2025-10-10 00:00:00',N'2 Nguyễn Du Quận Gò Vấp',NULL, NULL)
SELECT * FROM HoaDon
INSERT INTO CT_HoaDon 
VALUES 
	(1,1,'8000.0000','5',NULL),
	(1,2,'1200.0000','4',NUll),
	(1,3,'1000.0000','15',NULL),
	(2,2,'1200.0000','9',NULL),
	(2,4,'800.0000','5',NULL),
	(3,2,'3500.0000','20',NULL),
	(3,3,'1000.000','15',NULL)
SELECT * FROM CT_HoaDon
INSERT INTO NhanVien 
VALUES 
	(1,N'Phạm Văn Minh',NULL,NULL),
	(2,N'Nguyễn Thu Nguyệt',NULL,NULL)
SELECT * FROM NhanVien

UPDATE SanPham SET SLTON = SLTON + 100 WHERE MaNhom = 3 AND MaNCC = 2
SELECT * FROM SanPham
UPDATE KhachHang SET DiemTL = DiemTL + 50  WHERE LoaiKh <> 'VL'
SELECT * FROM KhachHang
ALTER TABLE SanPham 
ALTER COLUMN MoTa NVARCHAR(255);
UPDATE SanPham SET MoTa = N'Lò vi sóng công suất cao có nhiều chức năng đa dạng' WHERE TenSp = N'Lò vi sóng'
SELECT * FROM SanPham
UPDATE SanPham SET GiaGoc = GiaGoc * 1.02 WHERE TenSp LIKE N'%u%'
SELECT * FROM SanPham
DELETE FROM CT_HoaDon WHERE MaSp IN (SELECT MaSp FROM SanPham WHERE SLTON < 2)
SELECT * FROM CT_HoaDon
DELETE FROM SanPham WHERE SLTON < 2
SELECT * FROM SanPham
DELETE FROM CT_HoaDon WHERE MaHD IN (SELECT MaHD FROM HoaDon WHERE MaKh IN (SELECT MaKh FROM KhachHang WHERE LoaiKh = 'VL'))
SELECT * FROM CT_HoaDon
DELETE FROM HoaDon WHERE MaKh IN (SELECT MaKh FROM KhachHang WHERE LoaiKh = 'VL')
SELECT * FROM HoaDon
DELETE FROM CT_HoaDon WHERE MaHD IN (SELECT MaHD FROM HoaDon WHERE MaKh IN ( SELECT MaKh FROM KhachHang WHERE LoaiKh = 'VIP' AND DiemTL = 0))
SELECT * FROM CT_HoaDon
DELETE FROM KhachHang WHERE LoaiKh = 'VIP' AND DiemTL = 0
SELECT * FROM KhachHang